# Подсистема хранения и применения настроек

## Назначение
Подсистема хранит и применяет иерархические настройки аппаратуры. Основные операции:
- снять текущие настройки из аппаратуры и сохранить как снимок
- показать список снимков в UI и базовую сводку по ним
- применить выбранный снимок
- удалить снимок

Стек: C#, AvaloniaUI, Lamar, Prism (BindableBase, DelegateCommand).

## Архитектура
Слой `Settings.Core` содержит модели, репозитории и интерфейсы источников настроек.
- `ISettingsRepository` отвечает за сохранение/загрузку снимков.
- `ISettingsSource` абстрагирует аппаратное или сервисное состояние "как есть сейчас"
  и применение снимка к аппаратуре.

Слой `Settings.Controls` содержит UI для списка снимков и команды управления.
Слой `Settings.Host` подключает реализации (DI) и предоставляет временный источник.

## Модель данных
Модель снимка определена в `Settings.Core/Models/SettingsSnapshot.cs`.
- `SettingsSnapshot` — основной снимок: `Name`, `Mode`, `CreatedAt`, `UpdatedAt`, `Radio`
- `RadioSettings` — иерархия узлов тракта: `Antenna`, `Rpu`, `Detector`, `Demodulator`, `Decoder`
- каждый узел наследует `SettingsBlock`: `IsPresent`, `IsRelevant`, `Parameters`, `Sections`
- `AntennaSettings` дополнительно хранит `AntennaId`, `Tuning` (пара чисел для настройки),
  `Reference` (справочные параметры)
- `SettingsSection` — вложенная секция с `Values` и под-секциями
- `SettingValue` — пара ключ/значение внутри секции

Поля `Mode` и `Radio` отражают иерархию: глобальный режим и тракт с возможной
отсутствующей/неактуальной частью.

## Хранилище
`JsonSettingsRepository` сохраняет JSON на диск:
- основной путь: `%APPDATA%/Settings.Host/settings_snapshots.json`
- если файл отсутствует, пробует скопировать пример из `assets/settings_snapshots.json`

Это временная реализация. В будущем репозиторий можно заменить на БД
без изменения UI, оставив интерфейс `ISettingsRepository`.

## UI
Пользовательский контроль `Settings.Controls/Views/SettingsViewUserControl.axaml`
показывает таблицу:
- имя снимка
- режим
- время обновления
- ключевые параметры тракта (антенна/приемник/детектор/СКК/декодер) в человекочитаемом виде

Кнопки:
- "Снять" — создать снимок из текущего состояния (`ISettingsSource`)
- "Применить" — применить выбранный снимок
- "Удалить" — удалить выбранный снимок
- "Обновить" — перечитать список

## Потоки
1) Снятие:
   `ISettingsSource.GetCurrentAsync()` -> `ISettingsRepository.SaveAsync()` -> обновить список
2) Применение:
   `ISettingsApplier.ApplyAsync(snapshot, reporter)` -> пошаговое применение через стратегию по `Mode`
3) Удаление:
   `ISettingsRepository.DeleteAsync(id)` -> удалить из списка

## Применение по режимам
Применение реализовано стратегиями по `Mode`:
- `ISettingsApplyStrategy` выбирается по `SettingsSnapshot.Mode`
- `SettingsApplier` маршрутизирует в нужную стратегию
- `IApplyReporter` сообщает UI о шагах (старт/успех/ошибка)

UI показывает список шагов применения и итоговый статус.

## Точки расширения
1) Реальный источник настроек:
   заменить `MockSettingsSource` на аппаратную интеграцию.
2) Иерархия:
   детализировать узлы (под-секции, типизированные значения, новые свойства).
3) Представление:
   добавить отдельную панель для детального просмотра выбранного снимка.
4) Применение:
   добавить стратегии по новым режимам и детализировать шаги.

## Документация
- `docs/ARCHITECTURE.md` — подробное описание устройства подсистемы.
- `TASKS.md` — мелкие задачи для поэтапной работы.

## Текущее состояние
В `Settings.Host` используется `MockSettingsSource` — заглушка для разработки.
Ее нужно заменить на реальный адаптер аппаратуры.
